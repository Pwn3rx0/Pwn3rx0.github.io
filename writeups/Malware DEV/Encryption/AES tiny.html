<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shellcode Encryption with Tiny AES - pwn3rx0</title>
  <meta name="description" content="Implementing minimal AES-128 encryption and decryption for shellcode payloads using the Tiny AES library in C.">
  <meta name="keywords" content="cryptography, malware-development, aes, c, evasion, cybersecurity, security, writeups, ctf, pentest, penetration testing, red team, red teaming, malware, malware development, windows internals, windows api, shellcode, payload, injection, active directory, ad, ad enumeration, kerberoasting, lateral movement, post exploitation, defense evasion, opsec, privilege escalation, blue team, incident response, andrew mamdouh, pwn3rx0, andrew_mamdouh, malware dev, encryption">
  <meta name="author" content="Andrew Mamdouh (pwn3rx0)">
  <link rel="canonical" href="/writeups/Malware DEV/Encryption/AES tiny.html">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <meta property="og:title" content="Shellcode Encryption with Tiny AES">
  <meta property="og:description" content="Implementing minimal AES-128 encryption and decryption for shellcode payloads using the Tiny AES library in C.">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="pwn3rx0 blog">
  <meta property="og:image" content="/writeups/writeups-images/tinyAES.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="/writeups/Malware DEV/Encryption/AES tiny.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Shellcode Encryption with Tiny AES">
  <meta name="twitter:description" content="Implementing minimal AES-128 encryption and decryption for shellcode payloads using the Tiny AES library in C.">
  <meta name="twitter:image" content="/writeups/writeups-images/tinyAES.png">
  <meta name="site-base" content="/">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">
          <img src="/assets/images/profile.jpg" alt="Andrew Mamdouh">
        </div>
        <div class="profile-name">Andrew Mamdouh</div>
        <div class="profile-nick" style="color:#8a8f98;">(pwn3rx0)</div>
        <nav class="social-tabs">
          <a class="chip" href="https://github.com/pwn3rx0">GitHub</a>
          <a class="chip" href="https://www.linkedin.com/in/andrew-mamdouh122">LinkedIn</a>
          <a class="chip" href="https://x.com/pwn3rx0">X</a>
        </nav>
      </div>
      <nav class="category-tree"></nav>
    </aside>
    <main class="main-content">
      <nav class="breadcrumbs">
      
      <a href="/">Home</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV.html">Malware DEV</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/Encryption.html">Encryption</a>
    
      <span class="separator">/</span>
      <span class="current">Shellcode Encryption with Tiny AES</span>
    </nav>
      <article class="writeup">
        <header>
          <h1>Shellcode Encryption with Tiny AES</h1>
          <div class="writeup-meta">
            <div class="writeup-date">date: <time datetime="February 24, 2026 at 02:00 AM">February 24, 2026 at 02:00 AM</time></div>
            <div class="tags-row">
              <div class="tags-label">tags:</div>
              <div class="tags"><span class="tag">cryptography</span><span class="tag">malware-development</span><span class="tag">aes</span><span class="tag">c</span><span class="tag">evasion</span></div>
            </div>
            
          </div>
        </header>
        <div class="writeup-content"><h1>Using Tiny AES for Shellcode Encryption and Decryption in Visual Studio</h1>
<ul>
<li><strong>Tiny AES</strong> is a minimal and portable AES implementation in C.</li>
<li>Supports AES-128, AES-192, and AES-256 in ECB, CBC, and CTR modes.</li>
<li>Provides a simple API to perform AES encryption and decryption on binary data such as shellcode.</li>
<li>Requires proper padding of shellcode if not aligned to AES block size (16 bytes).</li>
<li>Encryption and decryption use the same key; using CBC mode requires an IV (initialization vector).</li>
</ul>
<hr>
<h3>Setup Tiny AES in Visual Studio</h3>
<ol>
<li>Download or clone the Tiny AES repository:  <a href="https://github.com/kokke/tiny-AES-c">Tiny AES</a></li>
<li>Add <code>aes.c</code> and <code>aes.h</code> files to your Visual Studio project.</li>
<li>add the Tiny AES path to include directories
<img src="/writeups/writeups-images/tinyAES.png" alt="tinyAES.png"></li>
</ol>
<hr>
<h3>Example C Code: Encrypt and Decrypt Shellcode with Tiny AES (CBC Mode)</h3>
<pre><code class="language-c">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &quot;aes.h&quot;

// AES parameters
#define AES_KEY_SIZE 16  // AES-128
#define AES_BLOCK_SIZE 16

// Example 16-byte AES key (must be kept secret)
static const uint8_t aes_key[AES_KEY_SIZE] = {
    0x60, 0x3d, 0xeb, 0x10, 0x15, 0xca, 0x71, 0xbe,
    0x2b, 0x73, 0xae, 0xf0, 0x85, 0x7d, 0x77, 0x81
};

// Initialization Vector for CBC (must be unique per encryption)
static const uint8_t aes_iv[AES_BLOCK_SIZE] = {
    0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
    0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f
};

// Pad shellcode to AES block size (simple zero padding example)
void pad_shellcode(unsigned char* buffer, size_t original_size, size_t padded_size) {
    memset(buffer + original_size, 0, padded_size - original_size);
}

int main() {
    // Original shellcode (must be multiple of AES_BLOCK_SIZE after padding)
    unsigned char shellcode[] = {
        0xfc, 0x48, 0x83, 0xe4, 0xf0, 0xe8,
        0xc0, 0x00, 0x00, 0x00, 0x41, 0x51, 0x41, 0x50, 0x52, 0x51
    };

    size_t shellcode_len = sizeof(shellcode);
    size_t padded_len = ((shellcode_len + AES_BLOCK_SIZE - 1) / AES_BLOCK_SIZE) * AES_BLOCK_SIZE;

    // Allocate buffer with padding space
    unsigned char* buffer = (unsigned char*)malloc(padded_len);
    if (!buffer) {
        printf(&quot;Memory allocation failed\n&quot;);
        return -1;
    }
    memcpy(buffer, shellcode, shellcode_len);
    pad_shellcode(buffer, shellcode_len, padded_len);

    struct AES_ctx ctx;

    // Encrypt shellcode using AES-128 CBC
    AES_init_ctx_iv(&amp;ctx, aes_key, aes_iv);
    AES_CBC_encrypt_buffer(&amp;ctx, buffer, padded_len);

    printf(&quot;Encrypted shellcode:\n&quot;);
    for (size_t i = 0; i &lt; padded_len; i++) {
        printf(&quot;0x%02x,&quot;, buffer[i]);
    }
    printf(&quot;\n&quot;);

    // Decrypt shellcode using AES-128 CBC
    AES_init_ctx_iv(&amp;ctx, aes_key, aes_iv);
    AES_CBC_decrypt_buffer(&amp;ctx, buffer, padded_len);

    printf(&quot;Decrypted shellcode:\n&quot;);
    for (size_t i = 0; i &lt; shellcode_len; i++) {
        printf(&quot;0x%02x,&quot;, buffer[i]);
    }
    printf(&quot;\n&quot;);

    free(buffer);
    return 0;
}
</code></pre>
<hr>
<h3>Notes:</h3>
<ul>
<li><strong>Padding</strong>: The shellcode must be padded to a multiple of 16 bytes since AES operates on fixed-size blocks.</li>
<li><strong>Key and IV Security</strong>: The AES key and IV must be kept confidential. IV should be unique per encryption session.</li>
<li><strong>Buffer Size</strong>: Always allocate sufficient memory for padding.</li>
<li><strong>Decryption</strong> reverses the encryption process using the same key and IV.</li>
<li><strong>CBC mode</strong> ensures more secure encryption than ECB mode by incorporating an IV.</li>
</ul>
</div>
        <nav class="post-navigation">
          <span class="nav-link disabled"><span class="nav-direction">← Previous</span><span class="nav-title">No older post</span></span>
          
      <a href="/writeups/Malware DEV/Encryption/Encryption.html" class="nav-link next-post">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">Shellcode Obfuscation & Encryption</span>
      </a>
    
        </nav>
        
      <aside class="related-posts">
        <h3>Related Writeups</h3>
        <ul class="related-list">
          <li><a href="/writeups/Malware DEV/Execution/Execution.html">Shellcode Execution & Injection Strategies</a></li><li><a href="/writeups/Malware DEV/Execution/Local Payload Execution.html">Local Payload Execution</a></li><li><a href="/writeups/Malware DEV/Execution/Remote ShellCode Injection.html">Remote Shellcode Injection</a></li>
        </ul>
      </aside>
    
      </article>
    </main>
  </div>
  <button class="mobile-menu-toggle">☰</button>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/navigation.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/c.min.js" defer></script>
  <script>
    (function() {
      function enhanceCodeBlocks(scope) {
        const container = scope || document.querySelector('.writeup-content') || document;
        const blocks = Array.from(container.querySelectorAll('pre > code')).filter(c => !c.closest('.code-block'));
        blocks.forEach(code => {
          const pre = code.parentElement;
          if (!pre || pre.dataset.enhanced === 'true') return;
          pre.dataset.enhanced = 'true';
          let langClass = Array.from(code.classList || []).find(c => c.startsWith('language-'));
          if (!langClass) {
            const t = code.textContent || '';
            if (/#include\s+<[^>]+>/.test(t) || /\bint\s+main\s*\(/.test(t) || /#include\s+<Windows\.h>/i.test(t)) {
              code.classList.add('language-c');
              langClass = 'language-c';
            }
          }
          const lang = (langClass ? langClass.replace('language-', '') : 'text').toUpperCase();
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block';
          const header = document.createElement('div');
          header.className = 'code-header';
          const langEl = document.createElement('span');
          langEl.className = 'code-lang';
          langEl.textContent = lang;
          const btn = document.createElement('button');
          btn.className = 'code-copy';
          btn.type = 'button';
          btn.textContent = 'Copy';
          btn.addEventListener('click', async () => {
            const text = code.innerText;
            const fallbackCopy = () => {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.position = 'fixed';
              ta.style.opacity = '0';
              ta.style.left = '-9999px';
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              try {
                document.execCommand('copy');
                btn.textContent = 'Copied';
              } catch (_) {
                btn.textContent = 'Failed';
              } finally {
                document.body.removeChild(ta);
                setTimeout(() => (btn.textContent = 'Copy'), 1200);
              }
            };
            try {
              if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                btn.textContent = 'Copied';
                setTimeout(() => (btn.textContent = 'Copy'), 1200);
              } else {
                fallbackCopy();
              }
            } catch (_) {
              fallbackCopy();
            }
          });
          header.appendChild(langEl);
          header.appendChild(btn);
          const holder = document.createElement('div');
          holder.className = 'code-content';
          pre.replaceWith(wrapper);
          holder.appendChild(pre);
          wrapper.appendChild(header);
          wrapper.appendChild(holder);
          if (window.hljs && typeof window.hljs.highlightElement === 'function') {
            window.hljs.highlightElement(code);
          } else if (window.hljs && typeof window.hljs.highlightAll === 'function') {
            window.hljs.highlightAll();
          }
        });
      }
      function indentAfterHeadings(scope) {
        const container = scope || document.querySelector('.writeup-content');
        if (!container) return;
        const headings = container.querySelectorAll('h1,h2,h3,h4,h5,h6');
        headings.forEach(h => {
          const level = parseInt(h.tagName.substring(1), 10);
          let el = h.nextElementSibling;
          while (el) {
            if (/^H[1-6]$/.test(el.tagName)) {
              const nextLevel = parseInt(el.tagName.substring(1), 10);
              if (nextLevel <= level) break;
            }
            if (el.tagName === 'P') {
              el.classList.add('indent-p');
            }
            el = el.nextElementSibling;
          }
        });
      }
      function initEnhancements() {
        if (window.mermaid) {
          mermaid.initialize({ startOnLoad: true, theme: 'dark' });
        }
        enhanceCodeBlocks();
        indentAfterHeadings();
        if (window.hljs && typeof window.hljs.highlightAll === 'function') {
          window.hljs.highlightAll();
        }
        const target = document.querySelector('.writeup-content');
        if (target && window.MutationObserver) {
          const mo = new MutationObserver(() => {
            enhanceCodeBlocks(target);
            indentAfterHeadings(target);
            if (window.hljs && typeof window.hljs.highlightAll === 'function') {
              window.hljs.highlightAll();
            }
          });
          mo.observe(target, { childList: true, subtree: true });
        }
      }
      window.addEventListener('load', initEnhancements);
    })();
  </script>
</body>
</html>
