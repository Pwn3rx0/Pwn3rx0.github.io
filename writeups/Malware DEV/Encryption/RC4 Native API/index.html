<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RC4 Stream Cipher (Native API) - pwn3rx0</title>
  <meta name="description" content="Implementing RC4 encryption and decryption using the undocumented Windows SystemFunction032/033 for stealthy shellcode obfuscation.">
  <meta name="keywords" content="malware-development, cryptography, rc4, win-api, evasion, cybersecurity, security, writeups, ctf, pentest, penetration testing, red team, red teaming, malware, malware development, windows internals, windows api, shellcode, payload, injection, active directory, ad, ad enumeration, kerberoasting, lateral movement, post exploitation, defense evasion, opsec, privilege escalation, blue team, incident response, andrew mamdouh, pwn3rx0, andrew_mamdouh, malware dev, encryption">
  <meta name="author" content="Andrew Mamdouh (pwn3rx0)">
  <link rel="canonical" href="/writeups/Malware DEV/Encryption/RC4 Native API/">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <meta property="og:title" content="RC4 Stream Cipher (Native API)">
  <meta property="og:description" content="Implementing RC4 encryption and decryption using the undocumented Windows SystemFunction032/033 for stealthy shellcode obfuscation.">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="pwn3rx0 blog">
  <meta property="og:image" content="/assets/images/og-home.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="/writeups/Malware DEV/Encryption/RC4 Native API/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="RC4 Stream Cipher (Native API)">
  <meta name="twitter:description" content="Implementing RC4 encryption and decryption using the undocumented Windows SystemFunction032/033 for stealthy shellcode obfuscation.">
  <meta name="twitter:image" content="/assets/images/og-home.png">
  <meta name="site-base" content="/">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">
          <img src="/assets/images/profile.jpg" alt="Andrew Mamdouh">
        </div>
        <div class="profile-name">Andrew Mamdouh</div>
        <div class="profile-nick" style="color:#8a8f98;">(pwn3rx0)</div>
        <nav class="social-tabs">
          <a class="chip" href="https://github.com/pwn3rx0">GitHub</a>
          <a class="chip" href="https://www.linkedin.com/in/andrew-mamdouh122">LinkedIn</a>
          <a class="chip" href="https://x.com/pwn3rx0">X</a>
        </nav>
      </div>
      <nav class="category-tree"></nav>
    </aside>
    <main class="main-content">
      <nav class="breadcrumbs">
      
      <a href="/">Home</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/">Malware DEV</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/Encryption/">Encryption</a>
    
      <span class="separator">/</span>
      <span class="current">RC4 Stream Cipher (Native API)</span>
    </nav>
      <article class="writeup">
        <header>
          <h1>RC4 Stream Cipher (Native API)</h1>
          <div class="writeup-meta">
            <div class="writeup-date">date: <time datetime="February 24, 2026 at 02:00 AM">February 24, 2026 at 02:00 AM</time></div>
            <div class="tags-row">
              <div class="tags-label">tags:</div>
              <div class="tags"><span class="tag">malware-development</span><span class="tag">cryptography</span><span class="tag">rc4</span><span class="tag">win-api</span><span class="tag">evasion</span></div>
            </div>
            
          </div>
        </header>
        <div class="writeup-content"><h1>RC4 Stream Cipher (Windows Native API Style)</h1>
<ul>
<li><strong>RC4</strong> is a symmetric stream cipher used for encrypting byte streams.</li>
<li>Same key used for encryption and decryption (reversible).</li>
</ul>
<hr>
<h3>Example C Code: RC4 Encryption/Decryption of Shellcode</h3>
<pre><code class="language-c">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

// Define NTSTATUS if not already defined
#ifndef NTSTATUS
typedef LONG NTSTATUS;
#endif

// Typedef for SystemFunction033 (RC4 encryption/decryption)
typedef NTSTATUS(WINAPI* _SystemFunction033)(
    struct ustring* memoryRegion,
    struct ustring* keyPointer
    );

// Structure used by SystemFunction033
typedef struct ustring {
    ULONG Length;
    ULONG MaximumLength;
    PUCHAR Buffer;
} ustring;

int main() {
    // Load advapi32.dll dynamically
    HMODULE hAdvapi = LoadLibraryW(L&quot;advapi32.dll&quot;);
    if (!hAdvapi) {
        printf(&quot;Failed to load advapi32.dll\n&quot;);
        return 1;
    }

    // Get the address of SystemFunction033 function
    _SystemFunction033 SystemFunction033 = (_SystemFunction033)GetProcAddress(hAdvapi, &quot;SystemFunction033&quot;);
    if (!SystemFunction033) {
        printf(&quot;Failed to find SystemFunction033\n&quot;);
        return 1;
    }

    // RC4 key for encryption/decryption
    char _key[] = &quot;SherlockWasHere&quot;;

    // Encrypted shellcode bytes (example)
    unsigned char shellcode[] = {
        0x5f, 0xfc, 0xb3, 0x2c, 0x87, 0xd5, 0xc1, 0xe8,
        0x2b, 0xac, 0x12, 0x8f, 0x00, 0x5e, 0xef, 0xd3
    };

    // Setup key ustring struct
    ustring key;
    key.Buffer = (PUCHAR)_key;
    key.Length = (ULONG)strlen(_key);
    key.MaximumLength = key.Length;

    // Setup data ustring struct for the shellcode
    ustring data;
    data.Buffer = shellcode;
    data.Length = sizeof(shellcode);
    data.MaximumLength = data.Length;
    // Decrypt shellcode in-place using SystemFunction033 (RC4)
    NTSTATUS status = SystemFunction033(&amp;data, &amp;key);
    if (status != 0) {
        printf(&quot;SystemFunction033 failed with status: 0x%08X\n&quot;, status);
        return 1;
    }

    SystemFunction033(&amp;data, &amp;key);

    return 0;
}
</code></pre>
<p>You can also use another native <a href="/writeups/Malware%20DEV/Windows%20API/Windows%20API/">Windows API</a>  <code>SystemFunction032</code> it also works.</p>
</div>
        <nav class="post-navigation">
          <span class="nav-link disabled"><span class="nav-direction">← Previous</span><span class="nav-title">No older post</span></span>
          
      <a href="/writeups/Malware DEV/Encryption/AES tiny/" class="nav-link next-post">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">Shellcode Encryption with Tiny AES</span>
      </a>
    
        </nav>
        
      <aside class="related-posts">
        <h3>Related Writeups</h3>
        <ul class="related-list">
          <li><a href="/writeups/Malware DEV/Execution/Execution/">Shellcode Execution & Injection Strategies</a></li><li><a href="/writeups/Malware DEV/Execution/Local Payload Execution/">Local Payload Execution</a></li><li><a href="/writeups/Malware DEV/Execution/Remote ShellCode Injection/">Remote Shellcode Injection</a></li>
        </ul>
      </aside>
    
      </article>
    </main>
  </div>
  <button class="mobile-menu-toggle">☰</button>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/navigation.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/c.min.js" defer></script>
  <script>(function(){function _0x23b25e(_0x1f6237){const _0xb16afd=_0x1f6237||document['querySelector']('.writeup-content')||document,_0x2f3adc=Array['from'](_0xb16afd['querySelectorAll']('pre\x20>\x20code'))['filter'](_0xcb6009=>!_0xcb6009['closest']('.code-block'));_0x2f3adc['forEach'](_0x1b2501=>{const _0x311ae2=_0x1b2501['parentElement'];if(!_0x311ae2||_0x311ae2['dataset']['enhanced']==='true')return;_0x311ae2['dataset']['enhanced']='true';let _0x19a6fc=Array['from'](_0x1b2501['classList']||[])['find'](_0x39858f=>_0x39858f['startsWith']('language-'));if(!_0x19a6fc){const _0x2d2f29=_0x1b2501['textContent']||'';(/#include\s+<[^>]+>/['test'](_0x2d2f29)||/\bint\s+main\s*\(/['test'](_0x2d2f29)||/#include\s+<Windows\.h>/i['test'](_0x2d2f29))&&(_0x1b2501['classList']['add']('language-c'),_0x19a6fc='language-c');}const _0x133c81=(_0x19a6fc?_0x19a6fc['replace']('language-',''):'text')['toUpperCase'](),_0xa4c6b4=document['createElement']('div');_0xa4c6b4['className']='code-block';const _0x4fd228=document['createElement']('div');_0x4fd228['className']='code-header';const _0x21ddc9=document['createElement']('span');_0x21ddc9['className']='code-lang',_0x21ddc9['textContent']=_0x133c81;const _0x322b6e=document['createElement']('button');_0x322b6e['className']='code-copy',_0x322b6e['type']='button',_0x322b6e['textContent']='Copy',_0x322b6e['addEventListener']('click',async()=>{const _0x5733fc=_0x1b2501['innerText'],_0x53f1f7=()=>{const _0x1819eb=document['createElement']('textarea');_0x1819eb['value']=_0x5733fc,_0x1819eb['style']['position']='fixed',_0x1819eb['style']['opacity']='0',_0x1819eb['style']['left']='-9999px',document['body']['appendChild'](_0x1819eb),_0x1819eb['focus'](),_0x1819eb['select']();try{document['execCommand']('copy'),_0x322b6e['textContent']='Copied';}catch(_0x5c7201){_0x322b6e['textContent']='Failed';}finally{document['body']['removeChild'](_0x1819eb),setTimeout(()=>_0x322b6e['textContent']='Copy',0x4b0);}};try{navigator['clipboard']&&window['isSecureContext']?(await navigator['clipboard']['writeText'](_0x5733fc),_0x322b6e['textContent']='Copied',setTimeout(()=>_0x322b6e['textContent']='Copy',0x4b0)):_0x53f1f7();}catch(_0x390504){_0x53f1f7();}}),_0x4fd228['appendChild'](_0x21ddc9),_0x4fd228['appendChild'](_0x322b6e);const _0x3cc54a=document['createElement']('div');_0x3cc54a['className']='code-content',_0x311ae2['replaceWith'](_0xa4c6b4),_0x3cc54a['appendChild'](_0x311ae2),_0xa4c6b4['appendChild'](_0x4fd228),_0xa4c6b4['appendChild'](_0x3cc54a);if(window['hljs']&&typeof window['hljs']['highlightElement']==='function')window['hljs']['highlightElement'](_0x1b2501);else window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});}function _0x330b53(_0x30df75){const _0x500839=_0x30df75||document['querySelector']('.writeup-content');if(!_0x500839)return;const _0x30c384=_0x500839['querySelectorAll']('h1,h2,h3,h4,h5,h6');_0x30c384['forEach'](_0x527885=>{const _0x47e89b=parseInt(_0x527885['tagName']['substring'](0x1),0xa);let _0x14fec1=_0x527885['nextElementSibling'];while(_0x14fec1){if(/^H[1-6]$/['test'](_0x14fec1['tagName'])){const _0x57cab7=parseInt(_0x14fec1['tagName']['substring'](0x1),0xa);if(_0x57cab7<=_0x47e89b)break;}_0x14fec1['tagName']==='P'&&_0x14fec1['classList']['add']('indent-p'),_0x14fec1=_0x14fec1['nextElementSibling'];}});}function _0x532e1c(){window['mermaid']&&mermaid['initialize']({'startOnLoad':!![],'theme':'dark'});_0x23b25e(),_0x330b53();window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();const _0x319c6e=document['querySelector']('.writeup-content');if(_0x319c6e&&window['MutationObserver']){const _0x2c05bf=new MutationObserver(()=>{_0x23b25e(_0x319c6e),_0x330b53(_0x319c6e),window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});_0x2c05bf['observe'](_0x319c6e,{'childList':!![],'subtree':!![]});}}window['addEventListener']('load',_0x532e1c);}());</script>
</body>
</html>
