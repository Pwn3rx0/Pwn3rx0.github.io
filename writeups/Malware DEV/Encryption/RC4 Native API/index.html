<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RC4 Stream Cipher (Native API) - pwn3rx0</title>
  <meta name="description" content="Implementing RC4 encryption and decryption using the undocumented Windows SystemFunction032/033 for stealthy shellcode obfuscation.">
  <meta name="keywords" content="malware-development, cryptography, rc4, win-api, evasion, cybersecurity, security, writeups, ctf, pentest, penetration testing, red team, red teaming, malware, malware development, windows internals, windows api, shellcode, payload, injection, active directory, ad, ad enumeration, kerberoasting, lateral movement, post exploitation, defense evasion, opsec, privilege escalation, blue team, incident response, andrew mamdouh, pwn3rx0, andrew_mamdouh, malware dev, encryption">
  <meta name="author" content="Andrew Mamdouh (pwn3rx0)">
  <link rel="canonical" href="/writeups/Malware DEV/Encryption/RC4 Native API/">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <meta property="og:title" content="RC4 Stream Cipher (Native API)">
  <meta property="og:description" content="Implementing RC4 encryption and decryption using the undocumented Windows SystemFunction032/033 for stealthy shellcode obfuscation.">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="pwn3rx0 blog">
  <meta property="og:image" content="/assets/images/og-home.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="/writeups/Malware DEV/Encryption/RC4 Native API/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="RC4 Stream Cipher (Native API)">
  <meta name="twitter:description" content="Implementing RC4 encryption and decryption using the undocumented Windows SystemFunction032/033 for stealthy shellcode obfuscation.">
  <meta name="twitter:image" content="/assets/images/og-home.png">
  <meta name="site-base" content="/">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">
          <img src="/assets/images/profile.jpg" alt="Andrew Mamdouh">
        </div>
        <div class="profile-name">Andrew Mamdouh</div>
        <div class="profile-nick" style="color:#8a8f98;">(pwn3rx0)</div>
        <nav class="social-tabs">
          <a class="chip" href="https://github.com/pwn3rx0">GitHub</a>
          <a class="chip" href="https://www.linkedin.com/in/andrew-mamdouh122">LinkedIn</a>
          <a class="chip" href="https://x.com/pwn3rx0">X</a>
        </nav>
      </div>
      <nav class="category-tree"></nav>
    </aside>
    <main class="main-content">
      <nav class="breadcrumbs">
      
      <a href="/">Home</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/">Malware DEV</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/Encryption/">Encryption</a>
    
      <span class="separator">/</span>
      <span class="current">RC4 Stream Cipher (Native API)</span>
    </nav>
      <article class="writeup">
        <header>
          <h1>RC4 Stream Cipher (Native API)</h1>
          <div class="writeup-meta">
            <div class="writeup-date">date: <time datetime="February 24, 2026 at 02:00 AM">February 24, 2026 at 02:00 AM</time></div>
            <div class="tags-row">
              <div class="tags-label">tags:</div>
              <div class="tags"><span class="tag">malware-development</span><span class="tag">cryptography</span><span class="tag">rc4</span><span class="tag">win-api</span><span class="tag">evasion</span></div>
            </div>
            
          </div>
        </header>
        <div class="writeup-content"><h1>RC4 Stream Cipher (Windows Native API Style)</h1>
<ul>
<li><strong>RC4</strong> is a symmetric stream cipher used for encrypting byte streams.</li>
<li>Same key used for encryption and decryption (reversible).</li>
</ul>
<hr>
<h3>Example C Code: RC4 Encryption/Decryption of Shellcode</h3>
<pre><code class="language-c">#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

// Define NTSTATUS if not already defined
#ifndef NTSTATUS
typedef LONG NTSTATUS;
#endif

// Typedef for SystemFunction033 (RC4 encryption/decryption)
typedef NTSTATUS(WINAPI* _SystemFunction033)(
    struct ustring* memoryRegion,
    struct ustring* keyPointer
    );

// Structure used by SystemFunction033
typedef struct ustring {
    ULONG Length;
    ULONG MaximumLength;
    PUCHAR Buffer;
} ustring;

int main() {
    // Load advapi32.dll dynamically
    HMODULE hAdvapi = LoadLibraryW(L&quot;advapi32.dll&quot;);
    if (!hAdvapi) {
        printf(&quot;Failed to load advapi32.dll\n&quot;);
        return 1;
    }

    // Get the address of SystemFunction033 function
    _SystemFunction033 SystemFunction033 = (_SystemFunction033)GetProcAddress(hAdvapi, &quot;SystemFunction033&quot;);
    if (!SystemFunction033) {
        printf(&quot;Failed to find SystemFunction033\n&quot;);
        return 1;
    }

    // RC4 key for encryption/decryption
    char _key[] = &quot;SherlockWasHere&quot;;

    // Encrypted shellcode bytes (example)
    unsigned char shellcode[] = {
        0x5f, 0xfc, 0xb3, 0x2c, 0x87, 0xd5, 0xc1, 0xe8,
        0x2b, 0xac, 0x12, 0x8f, 0x00, 0x5e, 0xef, 0xd3
    };

    // Setup key ustring struct
    ustring key;
    key.Buffer = (PUCHAR)_key;
    key.Length = (ULONG)strlen(_key);
    key.MaximumLength = key.Length;

    // Setup data ustring struct for the shellcode
    ustring data;
    data.Buffer = shellcode;
    data.Length = sizeof(shellcode);
    data.MaximumLength = data.Length;
    // Decrypt shellcode in-place using SystemFunction033 (RC4)
    NTSTATUS status = SystemFunction033(&amp;data, &amp;key);
    if (status != 0) {
        printf(&quot;SystemFunction033 failed with status: 0x%08X\n&quot;, status);
        return 1;
    }

    SystemFunction033(&amp;data, &amp;key);

    return 0;
}
</code></pre>
<p>You can also use another native <a href="/writeups/Malware%20DEV/Windows%20API/Windows%20API/">Windows API</a>  <code>SystemFunction032</code> it also works.</p>
</div>
        <nav class="post-navigation">
          <span class="nav-link disabled"><span class="nav-direction">← Previous</span><span class="nav-title">No older post</span></span>
          
      <a href="/writeups/Malware DEV/Encryption/AES tiny/" class="nav-link next-post">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">Shellcode Encryption with Tiny AES</span>
      </a>
    
        </nav>
        
      <aside class="related-posts">
        <h3>Related Writeups</h3>
        <ul class="related-list">
          <li><a href="/writeups/Malware DEV/Execution/Execution/">Shellcode Execution & Injection Strategies</a></li><li><a href="/writeups/Malware DEV/Execution/Local Payload Execution/">Local Payload Execution</a></li><li><a href="/writeups/Malware DEV/Execution/Remote ShellCode Injection/">Remote Shellcode Injection</a></li>
        </ul>
      </aside>
    
      </article>
    </main>
  </div>
  <button class="mobile-menu-toggle">☰</button>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/navigation.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/c.min.js" defer></script>
  <script>(function(){function _0x45c506(_0x39228c){const _0x40ffed=_0x39228c||document['querySelector']('.writeup-content')||document,_0x18177f=Array['from'](_0x40ffed['querySelectorAll']('pre\x20>\x20code'))['filter'](_0x79da36=>!_0x79da36['closest']('.code-block'));_0x18177f['forEach'](_0x55125a=>{const _0x144113=_0x55125a['parentElement'];if(!_0x144113||_0x144113['dataset']['enhanced']==='true')return;_0x144113['dataset']['enhanced']='true';let _0x3d5497=Array['from'](_0x55125a['classList']||[])['find'](_0x57a8ec=>_0x57a8ec['startsWith']('language-'));if(!_0x3d5497){const _0x2be5c1=_0x55125a['textContent']||'';(/#include\s+<[^>]+>/['test'](_0x2be5c1)||/\bint\s+main\s*\(/['test'](_0x2be5c1)||/#include\s+<Windows\.h>/i['test'](_0x2be5c1))&&(_0x55125a['classList']['add']('language-c'),_0x3d5497='language-c');}const _0x1943b6=(_0x3d5497?_0x3d5497['replace']('language-',''):'text')['toUpperCase'](),_0x1b1ee5=document['createElement']('div');_0x1b1ee5['className']='code-block';const _0x4d4cb3=document['createElement']('div');_0x4d4cb3['className']='code-header';const _0x41b27d=document['createElement']('span');_0x41b27d['className']='code-lang',_0x41b27d['textContent']=_0x1943b6;const _0xd518c7=document['createElement']('button');_0xd518c7['className']='code-copy',_0xd518c7['type']='button',_0xd518c7['textContent']='Copy',_0xd518c7['addEventListener']('click',async()=>{const _0x22659c=_0x55125a['innerText'],_0x48f534=()=>{const _0x220fee=document['createElement']('textarea');_0x220fee['value']=_0x22659c,_0x220fee['style']['position']='fixed',_0x220fee['style']['opacity']='0',_0x220fee['style']['left']='-9999px',document['body']['appendChild'](_0x220fee),_0x220fee['focus'](),_0x220fee['select']();try{document['execCommand']('copy'),_0xd518c7['textContent']='Copied';}catch(_0x35ccc9){_0xd518c7['textContent']='Failed';}finally{document['body']['removeChild'](_0x220fee),setTimeout(()=>_0xd518c7['textContent']='Copy',0x4b0);}};try{navigator['clipboard']&&window['isSecureContext']?(await navigator['clipboard']['writeText'](_0x22659c),_0xd518c7['textContent']='Copied',setTimeout(()=>_0xd518c7['textContent']='Copy',0x4b0)):_0x48f534();}catch(_0x86186){_0x48f534();}}),_0x4d4cb3['appendChild'](_0x41b27d),_0x4d4cb3['appendChild'](_0xd518c7);const _0x4d9f82=document['createElement']('div');_0x4d9f82['className']='code-content',_0x144113['replaceWith'](_0x1b1ee5),_0x4d9f82['appendChild'](_0x144113),_0x1b1ee5['appendChild'](_0x4d4cb3),_0x1b1ee5['appendChild'](_0x4d9f82);if(window['hljs']&&typeof window['hljs']['highlightElement']==='function')window['hljs']['highlightElement'](_0x55125a);else window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});}function _0x392b12(_0x31c8b9){const _0x1da14e=_0x31c8b9||document['querySelector']('.writeup-content');if(!_0x1da14e)return;const _0x232f80=_0x1da14e['querySelectorAll']('h1,h2,h3,h4,h5,h6');_0x232f80['forEach'](_0x45f3ea=>{const _0x25e768=parseInt(_0x45f3ea['tagName']['substring'](0x1),0xa);let _0xeb8a96=_0x45f3ea['nextElementSibling'];while(_0xeb8a96){if(/^H[1-6]$/['test'](_0xeb8a96['tagName'])){const _0x4ba006=parseInt(_0xeb8a96['tagName']['substring'](0x1),0xa);if(_0x4ba006<=_0x25e768)break;}_0xeb8a96['tagName']==='P'&&_0xeb8a96['classList']['add']('indent-p'),_0xeb8a96=_0xeb8a96['nextElementSibling'];}});}function _0x2b98a5(){window['mermaid']&&mermaid['initialize']({'startOnLoad':!![],'theme':'dark'});_0x45c506(),_0x392b12();window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();const _0x355016=document['querySelector']('.writeup-content');if(_0x355016&&window['MutationObserver']){const _0x195edc=new MutationObserver(()=>{_0x45c506(_0x355016),_0x392b12(_0x355016),window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});_0x195edc['observe'](_0x355016,{'childList':!![],'subtree':!![]});}}window['addEventListener']('load',_0x2b98a5);}());</script>
</body>
</html>
